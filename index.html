<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>PDF Uploader - Google Drive</title>
    
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://apis.google.com https://accounts.google.com;
        style-src 'self' 'unsafe-inline';
        connect-src 'self' https://www.googleapis.com https://accounts.google.com;
        frame-src https://accounts.google.com https://oauth2.googleapis.com;
        img-src 'self' data:;
        font-src 'self';
    ">

    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; border: 1px solid #eee; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #1a73e8; }
        h2 { border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; color: #3c4043; }
        
        button { 
            background-color: #4285F4; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            text-align: center; 
            text-decoration: none; 
            display: inline-block; 
            font-size: 16px; 
            margin: 8px 2px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { background-color: #3367D6; }
        button:disabled { background-color: #aeb4b8; cursor: not-allowed; }

        #upload-section, #history-section { border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px; }
        
        .file-link { 
            margin-bottom: 8px; 
            padding: 8px; 
            border-bottom: 1px dotted #ccc; 
            background-color: #f7f9fa; 
            border-radius: 4px;
        }
        .file-link a { 
            color: #188038; /* M√†u xanh c·ªßa th√†nh c√¥ng */
            text-decoration: none; 
            font-weight: bold;
        }
        .status { margin-top: 10px; font-weight: bold; color: red; }
    </style>
</head>
<body>

    <h1>üöÄ T·∫£i File PDF l√™n Google Drive & Qu·∫£n l√Ω Link</h1>

    <div id="auth-section" style="text-align: center;">
        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google ƒë·ªÉ ·ª©ng d·ª•ng c√≥ th·ªÉ k·∫øt n·ªëi v·ªõi Drive c·ªßa b·∫°n.</p>
        <button id="auth-button">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
    </div>

    <div id="upload-section" style="display: none;">
        <h2>T·∫£i File PDF L√™n Drive</h2>
        <p>Th∆∞ m·ª•c ƒë√≠ch: <span style="font-weight: bold; color: #3c4043;">D·ªØ li·ªáu B√°n H√†ng</span></p>
        <input type="file" id="pdf-file-input" accept="application/pdf" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
        <button id="upload-button" disabled>T·∫£i L√™n Drive</button>
        <div class="status" id="upload-status"></div>

        <h3>ƒê∆∞·ªùng d·∫´n File v·ª´a T·∫£i l√™n:</h3>
        <div id="new-file-link" class="file-link"></div>
    </div>

    <div id="history-section" style="display: none;">
        <h2>L·ªãch s·ª≠ ƒê∆∞·ªùng d·∫´n ƒê√£ L∆∞u (B·ªô nh·ªõ Tr√¨nh duy·ªát)</h2>
        <button id="download-history-button">T·∫£i v·ªÅ danh s√°ch (TXT)</button>
        <div id="history-list"></div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // --- 2. C·∫§U H√åNH API V√Ä BI·∫æN S·ªê ---
        const CLIENT_ID = '588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com';
        const FOLDER_ID = '1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P'; // ID folder D·ªØ li·ªáu B√°n H√†ng
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file'; 
        const LOCAL_STORAGE_KEY = 'pdfLinksHistory';

        // Bi·∫øn UI
        const authButton = document.getElementById('auth-button');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('pdf-file-input');
        const uploadStatus = document.getElementById('upload-status');
        const newFileLinkDiv = document.getElementById('new-file-link');
        const historyListDiv = document.getElementById('history-list');
        const downloadHistoryButton = document.getElementById('download-history-button');

        // --- 3. KH·ªûI T·∫†O V√Ä X√ÅC TH·ª∞C (AUTHENTICATION) ---

        // Kh·ªüi t·∫°o th∆∞ vi·ªán Google API
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        // Kh·ªüi t·∫°o Client OAuth
        function initClient() {
            gapi.client.init({
                clientId: CLIENT_ID,
                scope: SCOPES,
                discoveryDocs: DISCOVERY_DOCS
            }).then(() => {
                const authInstance = gapi.auth2.getAuthInstance();
                
                // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
                authInstance.isSignedIn.listen(updateSigninStatus);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu
                updateSigninStatus(authInstance.isSignedIn.get());

                // G√°n s·ª± ki·ªán
                authButton.onclick = handleAuthClick;
                uploadButton.onclick = handleUploadClick;
                fileInput.onchange = () => {
                    uploadButton.disabled = !fileInput.files.length;
                };
                downloadHistoryButton.onclick = downloadHistory;

            }, (error) => {
                uploadStatus.textContent = 'L·ªói kh·ªüi t·∫°o API: ' + JSON.stringify(error);
                console.error("L·ªói kh·ªüi t·∫°o Google API Client:", error);
            });
        }

        // C·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
                document.getElementById('history-section').style.display = 'block';
                loadHistoryFromLocalStorage();
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('history-section').style.display = 'none';
            }
        }

        // X·ª≠ l√Ω click n√∫t ƒëƒÉng nh·∫≠p
        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }

        // --- 4. CH·ª®C NƒÇNG T·∫¢I L√äN FILE & L·∫§Y LINK ---

        async function handleUploadClick() {
            const file = fileInput.files[0];
            if (!file) return;

            uploadStatus.textContent = `ƒêang t·∫£i l√™n "${file.name}"... Vui l√≤ng ch·ªù...`;
            newFileLinkDiv.innerHTML = '';
            uploadButton.disabled = true;

            try {
                const accessToken = gapi.auth.getToken().access_token;
                if (!accessToken) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c Access Token. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                
                // A. T·∫£i l√™n file b·∫±ng c√°ch s·ª≠ d·ª•ng Fetch API v·ªõi uploadType=multipart
                const fileMetadata = {
                    'name': file.name,
                    'parents': [FOLDER_ID], // Th∆∞ m·ª•c ƒë√≠ch
                    'mimeType': file.type // Lo·∫°i file (application/pdf)
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + accessToken
                    }),
                    body: form
                });

                const uploadedFile = await response.json();
                const fileId = uploadedFile.id;

                if (!fileId) throw new Error('T·∫£i l√™n th·∫•t b·∫°i ho·∫∑c kh√¥ng nh·∫≠n ƒë∆∞·ª£c ID file.');

                // B. Thi·∫øt l·∫≠p quy·ªÅn chia s·∫ª c√¥ng khai ("Anyone with the link can view")
                // Vi·ªác n√†y c·∫ßn quy·ªÅn Drive/Share, nh∆∞ng Drive.file c≈©ng ƒë·ªß n·∫øu folder ƒë√≠ch ƒë√£ ƒë∆∞·ª£c chia s·∫ª
                await gapi.client.drive.permissions.create({
                    fileId: fileId,
                    resource: {
                        'type': 'anyone',
                        'role': 'reader'
                    }
                });

                // C. L·∫•y ƒë∆∞·ªùng d·∫´n xem (webViewLink)
                const getFileResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    // webViewLink l√† ƒë∆∞·ªùng d·∫´n tr·ª±c ti·∫øp ƒë·ªÉ m·ªü file
                    fields: 'webViewLink, name' 
                });

                const fileLink = getFileResponse.result.webViewLink;
                const fileName = getFileResponse.result.name;
                const linkHTML = `<a href="${fileLink}" target="_blank">${fileName}</a> (T·∫£i l√™n th√†nh c√¥ng!)`;

                newFileLinkDiv.innerHTML = linkHTML;
                uploadStatus.textContent = `T·∫£i l√™n v√† chia s·∫ª ho√†n t·∫•t: ${fileName}`;
                uploadButton.disabled = false;
                fileInput.value = ''; 

                // D. L∆∞u ƒë∆∞·ªùng d·∫´n v√†o Local Storage v√† c·∫≠p nh·∫≠t l·ªãch s·ª≠
                saveLinkToLocalStorage(fileName, fileLink);

            } catch (error) {
                console.error("L·ªñI T·∫¢I L√äN FILE:", error);
                uploadStatus.textContent = 'L·ªñI T·∫¢I L√äN: ' + (error.result && error.result.error ? error.result.error.message : error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.');
                uploadButton.disabled = false;
            }
        }

        // --- 5. QU·∫¢N L√ù LOCAL STORAGE (THAY TH·∫æ CHO ·ªî E:) ---

        // L∆∞u ƒë∆∞·ªùng d·∫´n
        function saveLinkToLocalStorage(name, link) {
            let history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            const newEntry = { name: name, link: link, date: new Date().toLocaleString() };
            history.unshift(newEntry); // Th√™m v√†o ƒë·∫ßu danh s√°ch (m·ªõi nh·∫•t)
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(history));
            loadHistoryFromLocalStorage(); // C·∫≠p nh·∫≠t danh s√°ch hi·ªÉn th·ªã
        }

        // T·∫£i v√† hi·ªÉn th·ªã l·ªãch s·ª≠
        function loadHistoryFromLocalStorage() {
            const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            historyListDiv.innerHTML = '';

            if (history.length === 0) {
                historyListDiv.innerHTML = '<p>Ch∆∞a c√≥ ƒë∆∞·ªùng d·∫´n n√†o ƒë∆∞·ª£c l∆∞u tr·ªØ trong b·ªô nh·ªõ tr√¨nh duy·ªát n√†y.</p>';
                return;
            }

            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'file-link';
                // Hi·ªÉn th·ªã link c√≥ th·ªÉ k√≠ch ho·∫°t v√† m·ªü ƒë∆∞·ª£c PDF
                div.innerHTML = `<a href="${item.link}" target="_blank">${item.name}</a> <span style="font-size: small; color: #888;">(${item.date})</span>`;
                historyListDiv.appendChild(div);
            });
        }

        // Cho ph√©p ng∆∞·ªùi d√πng t·∫£i v·ªÅ file TXT (gi·∫£i ph√°p thay th·∫ø ·ªï E:)
        function downloadHistory() {
            const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            if (history.length === 0) {
                alert('Kh√¥ng c√≥ l·ªãch s·ª≠ ƒë∆∞·ªùng d·∫´n ƒë·ªÉ t·∫£i v·ªÅ.');
                return;
            }
            
            let text = "--- L·ªäCH S·ª¨ ƒê∆Ø·ªúNG D·∫™N PDF GOOGLE DRIVE ---\n\n";
            history.forEach(item => {
                text += `[${item.date}] ${item.name}:\n${item.link}\n\n`;
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lich_su_duong_dan_pdf.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        window.onload = handleClientLoad;
    </script>

</body>
</html>
