<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>PDF Uploader - Google Drive</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1 { text-align: center; color: #4285F4; }
        #auth-button, #upload-button, #download-history-button { background-color: #4285F4; color: white; border: none; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 4px; }
        #upload-section, #history-section { border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px; }
        .file-link { margin-bottom: 5px; padding: 5px; border-bottom: 1px dotted #ccc; }
        .file-link a { color: green; text-decoration: none; }
        .status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üöÄ PDF Uploader l√™n Google Drive</h1>

    <div id="auth-section" style="text-align: center;">
        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google ƒë·ªÉ s·ª≠ d·ª•ng.</p>
        <button id="auth-button">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
    </div>

    <div id="upload-section" style="display: none;">
        <h2>T·∫£i File PDF L√™n Drive</h2>
        <input type="file" id="pdf-file-input" accept="application/pdf">
        <button id="upload-button" disabled>T·∫£i L√™n Drive</button>
        <div class="status" id="upload-status"></div>

        <h3>ƒê∆∞·ªùng d·∫´n File v·ª´a T·∫£i l√™n:</h3>
        <div id="new-file-link" class="file-link"></div>
    </div>

    <div id="history-section" style="display: none;">
        <h2>L·ªãch s·ª≠ ƒê∆∞·ªùng d·∫´n ƒê√£ L∆∞u (Trong Tr√¨nh duy·ªát)</h2>
        <button id="download-history-button">T·∫£i v·ªÅ danh s√°ch (TXT)</button>
        <div id="history-list"></div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // --- 1. C·∫§U H√åNH API ---
        const CLIENT_ID = '588583798336-o4gjnfqaupmmdp8mi38o9m8r4n0bbghs.apps.googleusercontent.com';
        // B·∫°n c·∫ßn Client Secret ·ªü ph√≠a Server (Backend), nh∆∞ng v√¨ ƒë√¢y l√† Client-side, ch√∫ng ta ch·ªâ c·∫ßn Client ID
        // v√† c·∫•u h√¨nh Scopes ph√π h·ª£p.
        const FOLDER_ID = '1uyHJHfNFLIdPQbYu1uF4zliORCM6QK3P';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file'; // Quy·ªÅn ch·ªâ truy c·∫≠p/t·∫°o file c·ªßa ·ª©ng d·ª•ng

        // --- 2. BI·∫æN UI ---
        const authButton = document.getElementById('auth-button');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('pdf-file-input');
        const uploadStatus = document.getElementById('upload-status');
        const newFileLinkDiv = document.getElementById('new-file-link');
        const historyListDiv = document.getElementById('history-list');
        const downloadHistoryButton = document.getElementById('download-history-button');

        // --- 3. KH·ªûI T·∫†O V√Ä X√ÅC TH·ª∞C ---

        // Kh·ªüi t·∫°o th∆∞ vi·ªán Google API
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        // Kh·ªüi t·∫°o Client OAuth
        function initClient() {
            gapi.client.init({
                clientId: CLIENT_ID,
                scope: SCOPES,
                discoveryDocs: DISCOVERY_DOCS
            }).then(() => {
                // L·∫Øng nghe tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

                // G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p
                authButton.onclick = handleAuthClick;
                uploadButton.onclick = handleUploadClick;
                fileInput.onchange = () => {
                    uploadButton.disabled = !fileInput.files.length;
                };
                downloadHistoryButton.onclick = downloadHistory;

            }, (error) => {
                uploadStatus.textContent = 'L·ªói kh·ªüi t·∫°o API: ' + JSON.stringify(error);
            });
        }

        // C·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
                document.getElementById('history-section').style.display = 'block';
                loadHistoryFromLocalStorage();
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('history-section').style.display = 'none';
            }
        }

        // X·ª≠ l√Ω click n√∫t ƒëƒÉng nh·∫≠p
        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }

        // --- 4. CH·ª®C NƒÇNG T·∫¢I L√äN FILE ---

        async function handleUploadClick() {
            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.textContent = 'Vui l√≤ng ch·ªçn file PDF.';
                return;
            }

            uploadStatus.textContent = `ƒêang t·∫£i l√™n "${file.name}"...`;
            uploadButton.disabled = true;

            try {
                // A. T·∫£i l√™n file
                const fileMetadata = {
                    'name': file.name,
                    // L∆∞u file v√†o th∆∞ m·ª•c ƒë√≠ch
                    'parents': [FOLDER_ID]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                form.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + gapi.auth.getToken().access_token
                    }),
                    body: form
                });

                const uploadedFile = await response.json();
                const fileId = uploadedFile.id;

                if (!fileId) throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ID file sau khi upload.');

                // B. Thi·∫øt l·∫≠p quy·ªÅn chia s·∫ª c√¥ng khai ("Anyone with the link")
                const permissionResponse = await gapi.client.drive.permissions.create({
                    fileId: fileId,
                    resource: {
                        'type': 'anyone',
                        'role': 'reader'
                    }
                });

                // C. L·∫•y th√¥ng tin file (ƒë·ªÉ c√≥ webViewLink)
                const getFileResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    fields: 'webViewLink, name'
                });

                const fileLink = getFileResponse.result.webViewLink;
                const fileName = getFileResponse.result.name;
                const linkHTML = `<a href="${fileLink}" target="_blank">${fileName}</a> (T·∫£i l√™n th√†nh c√¥ng!)`;

                newFileLinkDiv.innerHTML = linkHTML;
                uploadStatus.textContent = 'T·∫£i l√™n ho√†n t·∫•t.';
                uploadButton.disabled = false;
                fileInput.value = ''; // X√≥a file ƒë√£ ch·ªçn

                // D. L∆∞u ƒë∆∞·ªùng d·∫´n v√†o Local Storage v√† c·∫≠p nh·∫≠t l·ªãch s·ª≠
                saveLinkToLocalStorage(fileName, fileLink);

            } catch (error) {
                console.error(error);
                uploadStatus.textContent = 'L·ªñI T·∫¢I L√äN: ' + (error.message || 'Ki·ªÉm tra Console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
                uploadButton.disabled = false;
            }
        }

        // --- 5. QU·∫¢N L√ù LOCAL STORAGE ---

        // L∆∞u ƒë∆∞·ªùng d·∫´n
        function saveLinkToLocalStorage(name, link) {
            let history = JSON.parse(localStorage.getItem('pdfLinksHistory') || '[]');
            const newEntry = { name: name, link: link, date: new Date().toLocaleString() };
            history.unshift(newEntry); // Th√™m v√†o ƒë·∫ßu danh s√°ch
            localStorage.setItem('pdfLinksHistory', JSON.stringify(history));
            loadHistoryFromLocalStorage(); // C·∫≠p nh·∫≠t danh s√°ch hi·ªÉn th·ªã
        }

        // T·∫£i v√† hi·ªÉn th·ªã l·ªãch s·ª≠
        function loadHistoryFromLocalStorage() {
            const history = JSON.parse(localStorage.getItem('pdfLinksHistory') || '[]');
            historyListDiv.innerHTML = '';

            if (history.length === 0) {
                historyListDiv.innerHTML = '<p>Ch∆∞a c√≥ ƒë∆∞·ªùng d·∫´n n√†o ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát n√†y.</p>';
                return;
            }

            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'file-link';
                div.innerHTML = `<a href="${item.link}" target="_blank">${item.name}</a> <span style="font-size: small; color: #888;">(${item.date})</span>`;
                historyListDiv.appendChild(div);
            });
        }

        // Cho ph√©p ng∆∞·ªùi d√πng t·∫£i v·ªÅ file TXT
        function downloadHistory() {
            const history = JSON.parse(localStorage.getItem('pdfLinksHistory') || '[]');
            if (history.length === 0) {
                alert('Kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n n√†o ƒë·ªÉ t·∫£i v·ªÅ.');
                return;
            }
            
            let text = "--- L·ªäCH S·ª¨ ƒê∆Ø·ªúNG D·∫™N PDF GOOGLE DRIVE ---\n\n";
            history.forEach(item => {
                text += `[${item.date}] ${item.name}:\n${item.link}\n\n`;
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lich_su_duong_dan_pdf.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng khi trang web t·∫£i xong
        window.onload = handleClientLoad;
    </script>

</body>
</html>
